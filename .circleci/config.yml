# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2

restore_gradle_cache: &restore_gradle_cache
  restore_cache:
    keys:
      - gradle-dep-{{ checksum "build.gradle" }}
      - gradle-dep-

save_gradle_cache: &save_gradle_cache
  save_cache:
    paths:
      - /home/circleci/.gradle
    key: gradle-dep-{{ checksum "build.gradle" }}

copy_test_result: &copy_test_result
  run:
    command: |
      mkdir -p $TEST_RESULT
      find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} $TEST_RESULT \;
    when: always

jobs:
  # ====================
  # Stage 1.1: Unit Test
  # ====================
  unitTest:
    docker:
      - image: circleci/openjdk:8-jdk
    working_directory: ~/repo
    environment:
      JVM_OPTS: -Xmx3200m
      TERM: dumb
      TEST_RESULT: ~/unit
    steps:
      - checkout
      - *restore_gradle_cache
      - run: gradle dependencies
      - *save_gradle_cache
      - run: gradle unitTests
      - *copy_test_result
      - store_test_results:
          path: $TEST_RESULT
      - store_artifacts:
          path: $TEST_RESULT

  # ===========================
  # Stage 1.2: Integration Test
  # ===========================
  integrationTest:
    docker:
      - image: circleci/openjdk:8-jdk
    working_directory: ~/repo
    environment:
      JVM_OPTS: -Xmx3200m
      TERM: dumb
      TEST_RESULT: ~/integration
    steps:
      - checkout
      - *restore_gradle_cache
      - run: gradle dependencies
      - *save_gradle_cache
      - run: gradle integrationTests
      - *copy_test_result
      - store_test_results:
          path: $TEST_RESULT
      - store_artifacts:
          path: $TEST_RESULT

  # ===============================================
  # Step 3: Build Artifact, docker image and upload
  # ===============================================
  build:
    docker:
      - image: circleci/openjdk:8-jdk
    working_directory: ~/repo
    environment:
      JVM_OPTS: -Xmx3200m
      TERM: dumb
    steps:
      - checkout
      - *restore_gradle_cache
      - run: gradle dependencies
      - *save_gradle_cache
      - run: gradle shadowJar
      - run:
          command: |
            mkdir -p ~/jars/
            find . -type f -regex ".*/build/libs/heimdall-.*jar" -exec cp {} ~/jars/ \;
      - store_artifacts:
          path: ~/jars
      # Build docker image
      - setup_remote_docker
      - run:
          name: Build docker image
          command: |
            docker build -t imulab/heimdall:latest .
      - run:
          name: Upload docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
              docker push imulab/heimdall:latest
              echo "pushed image to docker"
            fi

workflows:
  version: 2
  test_and_build:
    jobs:
      - unitTest
      - integrationTest
      - build:
          requires:
            - unitTest
            - integrationTest